<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="postMapper">

    <insert id="insertPost">
        INSERT INTO recipepost (recipetitle, recipecontent, recipewritedate, userid, maincategoryid, subcategoryid, subcategoryname, isprivate, recipedeactivate)
        VALUES (#{recipetitle}, #{recipecontent}, NOW(), #{userid}, #{maincategoryid}, #{subcategoryid}, #{subcategoryname}, #{isprivate}, 0);
    </insert>

    <insert id="insertTags">
        INSERT INTO recipetag (recipeid, tagorder, tagname)
        VALUES
        <foreach collection="tags" item="tag" separator=",">
            (#{recipeid}, #{tag.tagorder}, #{tag.tagname})
        </foreach>
    </insert>

    <insert id="insertAttachments">
        INSERT INTO attachment (fileorder, filename, fileuuid, fileext, recipeid)
        VALUES
        <foreach collection="attachments" item="att" separator=",">
            (#{att.fileorder}, #{att.filename}, #{att.fileuuid}, #{att.fileext}, #{recipeid})
        </foreach>
    </insert>
    
    <insert id="insertIngredients">
	    INSERT INTO ingredients (recipeid, ingorder, ingname, ingquantity, unit, exp)
	    VALUES
	    <foreach collection="ingredients" item="ing" separator=",">
	        (#{recipeid}, #{ing.ingorder}, #{ing.ingname}, #{ing.ingquantity}, #{ing.unit}, #{ing.exp})
	    </foreach>
	</insert>

    <insert id="insertSequences">
        INSERT INTO recipesequence (recipeid, recipestep, explain, recipevidlink, ingactivate, toolactivate, fireactivate, tipactivate, ingexp, toolexp, fireexp, tipexp)
        VALUES
        <foreach collection="sequences" item="seq" separator=",">
            (#{recipeid}, #{seq.recipestep}, #{seq.explain}, #{seq.recipevidlink},
             #{seq.ingactivate}, #{seq.toolactivate}, #{seq.fireactivate}, #{seq.tipactivate},
             #{seq.ingexp}, #{seq.toolexp}, #{seq.fireexp}, #{seq.tipexp})
        </foreach>
    </insert>

    <select id="getAllPosts" resultType="com.recipetime.find.Model.Post">
        SELECT * FROM recipepost WHERE recipedeactivate = 0 AND isprivate = 1
    </select>

    <select id="getPostById" resultType="com.recipetime.find.Model.Post">
        SELECT *
        FROM recipepost
        WHERE recipeid = #{recipeid}
          AND (
              (#{isAdmin} = true AND recipedeactivate = 1)
              OR (#{isAdmin} = false AND recipedeactivate = 0)
          )
          AND (
              isprivate = 1
              OR (isprivate = 0 AND userid = #{currentUserId})
          )
    </select>
    
    <update id="deactivatePost">
	    UPDATE recipepost
	    SET recipedeactivate = 1,
	        isprivate = 1,
	        recipedeactivatedate = NOW()
	    WHERE recipeid = #{recipeid}
	</update>
</mapper>